{% extends 'base.html.twig' %}

{% block title %}{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .info-card{
            max-width: 760px;
            margin: 24px auto 0;
            padding: 22px;
            border-radius: 16px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.12);
        }

        .info-card h1{
            margin: 0 0 8px;
            font-size: clamp(1.6rem, 2.5vw, 2.2rem);
        }

        .info-card p{
            margin: 0 0 16px;
            color: rgba(255,255,255,.66);
        }

        .info-card .meta{
            font-size: .95rem;
            color: rgba(255,255,255,.66);
        }
        .LogOutBtn{

        }
    </style>
{% endblock %}
{% block body %}

    <header class="topbar">
        <form method="post" action="/logout">
            <button type="submit">Logout</button>
        </form>
    </header>



    <section class="info-card">
        <h1>Hello {{ Username }}! </h1>
        <p>{% for Role in Roles %}{{ Role }}{% endfor %}</p>

        <div id="emailDisplay">
            {% if hasEmail %}
                <p>Your email is: {{ email }}</p>
            {% else %}
            <form id="emailForm" method="post">
                <p>Enter your Email</p>
                <input id="emailInput" type="email" name="email" required>
                <button type="submit">Add</button>
                <small id="emailTaken" style="display:none;" aria-live="polite">Email is taken</small>
                <input type="hidden" name="_token" value="{{ csrf_token('add_email') }}">
            </form>
            {% endif %}
            <form id="codeForm" method="post" style="display: none">
                <p>Enter the Code we sent you</p>
                <input id="codeInput" type="number" name="code" required>
                <button type="submit">Confirm</button>
                <small id="wrongCode" style="display:none;" aria-live="polite">Wrong Code</small>
                <input type="hidden" name="_token" value="{{ csrf_token('confirm_email') }}">
            </form>
        </div>
    </section>


    <script>
        const emailForm = document.getElementById('emailForm');
        const codeForm  = document.getElementById('codeForm');

        async function ajaxSubmit(e) {
            e.preventDefault();
            const form = e.currentTarget;

            document.getElementById('wrongCode').style.display = 'none';
            document.getElementById('emailTaken').style.display = 'none';

            const res = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            });

            const data = await res.json();

            if (!data.emailSent) {
                emailForm.style.display = 'inline';
                codeForm.style.display = 'none';
            } else if (data.emailSent && !data.emailConfirmed) {
                codeForm.style.display = 'inline';
                emailForm.style.display = 'none';
            } else {
                codeForm.style.display = 'none';
                emailForm.style.display = 'none';
                document.getElementById('emailDisplay').innerHTML =
                    `<p>Your email is: ${data.email}</p>`;
            }

            if (data.error) {
                document.getElementById('wrongCode').style.display = 'inline';
            }
            if (data.emailExists) {
                document.getElementById('emailTaken').style.display = 'inline';
            }
        }

        emailForm?.addEventListener('submit', ajaxSubmit);
        codeForm?.addEventListener('submit', ajaxSubmit);
    </script>

{% endblock %}
