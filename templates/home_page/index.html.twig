{% extends 'base.html.twig' %}

{% block title %}{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .info-card{
            max-width: 760px;
            margin: 24px auto 0;
            padding: 22px;
            border-radius: 16px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.12);
        }

        .info-card h1{
            margin: 0 0 8px;
            font-size: clamp(1.6rem, 2.5vw, 2.2rem);
        }

        .info-card p{
            margin: 0 0 16px;
            color: rgba(255,255,255,.66);
        }

        .info-card .meta{
            font-size: .95rem;
            color: rgba(255,255,255,.66);
        }
        .LogOutBtn{

        }
    </style>
{% endblock %}
{% block body %}

    <header class="topbar">
        <form method="post" action="/logout">
            <button type="submit">Logout</button>
        </form>
    </header>



    <section class="info-card">
        <h1>Hello {{ Username }}! </h1>
        <p>{% for Role in Roles %}{{ Role }}{% endfor %}</p>

        <div id="emailDisplay">
            {% if hasEmail %}
                <form id="emailDeleteForm" method="post">
                    <p>Your email is: {{ email }}</p>
                    <input type="hidden" name="delete" value="1">
                    <button type="submit">Delete</button>
                    <input type="hidden" name="_token" value="{{ csrf_token('delete_email') }}">
                </form>
            {% else %}
            <form id="emailForm" method="post">
                <p>Enter your Email</p>
                <input id="emailInput" type="email" name="email" required>
                <button type="submit">Add</button>
                <small id="emailTaken" style="display:none;" aria-live="polite">Email is taken</small>
                <small id="EmailIsSent" style="display:none;" aria-live="polite">Email is already sent</small>
                <input type="hidden" name="_token" value="{{ csrf_token('add_email') }}">
            </form>
            {% endif %}
            <form id="codeForm" method="post" style="display: none">
                <p>Enter the Code we sent you</p>
                <input id="codeInput" type="number" name="code" required>
                <button type="submit">Confirm</button>
                <small id="wrongCode" style="display:none;" aria-live="polite">Wrong Code</small>
                <small id="tooManyAttempts" style="display:none;" aria-live="polite">Too many incorrect attempts, try again later.</small>
                <input type="hidden" name="_token" value="{{ csrf_token('confirm_email') }}">
            </form>
        </div>
    </section>


    <script>
        const emailForm = document.getElementById('emailForm');
        const codeForm  = document.getElementById('codeForm');
        const deleteForm = document.getElementById('emailDeleteForm');

        const CSRF_DELETE_EMAIL = "{{ csrf_token('delete_email') }}";

        const byId = (id) => document.getElementById(id);
        const hide = (id) => { const el = byId(id); if (el) el.style.display = 'none'; };
        const show = (id) => { const el = byId(id); if (el) el.style.display = 'inline'; };

        async function ajaxSubmit(e) {
            e.preventDefault();
            const form = e.currentTarget;

            hide('wrongCode');
            hide('emailTaken');
            hide('tooManyAttempts');
            hide('EmailIsSent');

            const res = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            });

            const data = await res.json();

            if(data.deleted){
                location.reload();
                return;
            }

            if (!data.emailSent) {
                emailForm.style.display = 'inline';
                codeForm.style.display = 'none';
            } else if (data.emailSent && !data.emailConfirmed) {
                codeForm.style.display = 'inline';
                emailForm.style.display = 'none';
            } else {
                location.reload();
                return;
            }

            if (data.error === 'Wrong code') {
                document.getElementById('wrongCode').style.display = 'inline';
            } else if (data.error === 'Too many incorrect attempts') {
                document.getElementById('tooManyAttempts').style.display = 'inline';
            } else if (data.error === 'Email sent too often') {
                document.getElementById('EmailIsSent').style.display = 'inline';
            }
            if (data.emailExists) {
                document.getElementById('emailTaken').style.display = 'inline';
            }
            if (data.emailExists) show('emailTaken');
        }

        deleteForm?.addEventListener('submit', ajaxSubmit);
        emailForm?.addEventListener('submit', ajaxSubmit);
        codeForm?.addEventListener('submit', ajaxSubmit);
    </script>

{% endblock %}
